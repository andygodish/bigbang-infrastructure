# Infrastrucuture

Single node used for to standup a bigbang dev cluster. 

Modules controlled by terragrunt create a single node cluster in a private subnet behind a bastion host with a public IP. By default, a single AZ is used. 

## Terragrunt

```
cd ./grunt

# Edit configuration files, region.yaml, ./dev/env.yaml

terragrunt run-all init
terragrunt run-all apply
```

This repo is using local terraform state storage. S3 configurations are commented out in /terraform/infrastructure/terragrunt.hcl

## RKE2-Server not Initially Starting - Fix

For some reason, the terraform module used for the server nodepool fails to start RKE2. Until the cause of this issue is identified, rke2 can be uninstalled and then reinstalled using the same config generated by the module. This also prevents the tf module from copying the rke2 kubeconfig to the s3 bucket used for storage. 

```
cp /etc/rancher/rke2/config.yaml /tmp/config.yaml

/usr/bin/rke2-uninstall.sh

curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION=v1.21.10+rke2r2 sh -

mkdir -p /etc/rancher/rke2/

cp /tmp/config.yaml /etc/rancher/rke2

systemctl enable rke2-server

systemctl start rke2-server

cp /etc/rancher/rke2/rke2.yaml /tmp/rke2.yaml
sed -i -e "s/127.0.0.1/${cp_lb_host}/g" /tmp/rke2.yaml
chmod 644 /tmp/rke2.yaml

# From local machine
scp dev_server:/tmp/rke2.yaml /tmp/
aws s3 cp /tmp/rke2.yaml s3://bigbang-dev-1h4-rke2/rke2.yaml
```

## Kubeconfig
Pull in kubeconfig from aws s3

```
export PATH=/var/lib/rancher/rke2/bin:$PATH
export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
alias k=kubectl

aws s3 cp s3://bigbang-dev-1h4-rke2/rke2.yaml ~/.kube/config
```

## Disable PSPs (BB Requirement)

```
kubectl patch psp system-unrestricted-psp -p '{"metadata": {"annotations":{"seccomp.security.alpha.kubernetes.io/allowedProfileNames": "*"}}}'
kubectl patch psp global-unrestricted-psp -p '{"metadata": {"annotations":{"seccomp.security.alpha.kubernetes.io/allowedProfileNames": "*"}}}'
kubectl patch psp global-restricted-psp -p '{"metadata": {"annotations":{"seccomp.security.alpha.kubernetes.io/allowedProfileNames": "*"}}}'
```

